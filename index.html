<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Loja Virtual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; 
        }
        .main-content-area {
            min-height: calc(100vh - 4rem); 
        }
        .main-content-section {
            min-height: calc(100vh - 8rem); 
        }
        .product-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            position: relative; /* Para o botão de wishlist */
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .feedback-message {
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .feedback-success {
            background-color: #D1FAE5;
            color: #065F46;
            border: 1px solid #6EE7B7;
        }
        .feedback-error {
            background-color: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FCA5A5;
        }
        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 0.375rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            background-color: #f9fafb;
        }
        .drop-zone.dragover {
            background-color: #eff6ff;
            border-color: #93c5fd;
        }
        .product-image-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
        }
        #side-menu {
            transition: transform 0.3s ease-in-out;
        }
        #side-menu.open {
            transform: translateX(0);
        }
        #side-menu-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .product-detail-image-container {
            max-height: 400px; 
            position: relative;
        }
        .product-detail-image {
            width: 100%;
            height: 100%;
            max-height: 400px;
            object-fit: contain; 
            border-radius: 0.5rem; 
        }
        .add-to-cart-feedback {
            transition: opacity 0.3s ease-in-out;
        }
        .pix-qr-code {
            width: 200px; 
            height: 200px; 
            border: 1px solid #e5e7eb; 
        }
        .category-filter-button.active {
            background-color: #3B82F6;
            color: white;
        }
        #admin-add-product-feedback-container {
            padding: 1rem;
            border: 1px solid #6EE7B7;
            background-color: #D1FAE5;
            color: #065F46;
            border-radius: 0.375rem;
            margin-top: 1rem;
        }
        .out-of-stock-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.125rem;
            border-radius: 0.375rem;
            text-align: center;
            padding: 0.5rem;
        }
        .carousel-button {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .carousel-button:hover {
            background-color: rgba(0, 0, 0, 0.75);
        }
        .image-indicators {
            position: absolute;
            bottom: 0.5rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
        }
        .image-indicator-dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 9999px;
            background-color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
        }
        .image-indicator-dot.active {
            background-color: white;
        }
        .admin-nav-button.active {
            background-color: #3B82F6;
            color: white;
        }
        .admin-nav-button {
            background-color: #E5E7EB;
            color: #374151;
        }
        .filter-btn.active {
            background-color: #3B82F6;
            color: white;
        }
        .wishlist-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ddd;
            border-radius: 50%;
            padding: 0.5rem;
            cursor: pointer;
            z-index: 10;
        }
        .wishlist-button svg {
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            fill: none;
            stroke: #F87171; /* text-red-400 */
        }
        .wishlist-button.active svg {
            fill: #EF4444; /* text-red-500 */
            stroke: #EF4444;
        }
        .star-rating span {
            cursor: pointer;
            font-size: 1.5rem; /* text-2xl */
            color: #D1D5DB; /* text-gray-300 */
        }
        .star-rating span.selected, .star-rating span:hover, .star-rating span:hover ~ span {
            color: #FBBF24; /* text-yellow-400 */
        }
        .star-rating span:hover ~ span { /* Make subsequent stars also yellow on hover */
             color: #FBBF24;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="side-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

    <aside id="side-menu" class="fixed top-0 left-0 w-72 h-full bg-white shadow-xl z-50 transform -translate-x-full p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-700">Menu</h2>
            <button id="close-menu-button" class="text-gray-600 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <div id="login-section-menu">
            <h3 class="text-lg font-medium text-gray-700 mb-3 border-b pb-2">Acesso Restrito (Admin)</h3>
            <div id="login-feedback-menu" class="hidden"></div>
            <form id="login-form-menu">
                <div class="mb-3">
                    <label for="email-menu" class="block text-sm font-medium text-gray-600 mb-1">Email Admin</label>
                    <input type="email" id="email-menu" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="admin@email.com" required>
                </div>
                <div class="mb-3">
                    <label for="senha-menu" class="block text-sm font-medium text-gray-600 mb-1">Senha</label>
                    <input type="password" id="senha-menu" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="********" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300 text-sm">Entrar (Admin)</button>
            </form>
        </div>

        <div id="admin-info-section-menu" class="hidden mt-4">
            <p class="text-sm text-gray-600 mb-2">Logado como Admin: <span id="admin-email-display-menu" class="font-medium"></span></p>
            <button id="admin-logout-button-menu" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition duration-300 text-sm mb-2">Logout Admin</button>
            <a href="#" id="admin-panel-link-side-menu" class="block text-sm text-center w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-300">Painel Admin</a>
        </div>
        
        <div class="mt-6 pt-4 border-t">
            <h3 class="text-lg font-medium text-gray-700 mb-3">Cliente</h3>
            <div id="client-login-section-menu">
                <form id="client-login-form-menu">
                     <div class="mb-3">
                        <label for="client-email-menu" class="block text-sm font-medium text-gray-600 mb-1">Email Cliente</label>
                        <input type="email" id="client-email-menu" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="cliente@email.com" required>
                    </div>
                    <div class="mb-3">
                        <label for="client-senha-menu" class="block text-sm font-medium text-gray-600 mb-1">Senha Cliente</label>
                        <input type="password" id="client-senha-menu" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="********" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 text-sm mb-2">Login Cliente</button>
                </form>
                <div id="client-login-feedback-menu" class="text-xs mt-1"></div>
                <a href="#" id="register-client-link" class="block text-sm text-blue-600 hover:underline text-center mt-2">Criar minha conta</a>
            </div>
            <div id="client-info-section-menu" class="hidden mt-2">
                <p class="text-sm text-gray-600 mb-2">Logado como: <span id="client-email-display-menu" class="font-medium"></span></p>
                <a href="#" id="my-wishlist-link-menu" class="block text-sm text-gray-600 hover:bg-gray-100 p-2 rounded-md">Minha Lista de Desejos</a>
                <a href="#" id="my-orders-link-menu" class="block text-sm text-gray-600 hover:bg-gray-100 p-2 rounded-md">Meus Pedidos</a>
                <button id="client-logout-button-menu" class="mt-2 w-full bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 text-sm">Logout Cliente</button>
            </div>
        </div>
    </aside>

    <header class="bg-white shadow-md sticky top-0 z-30"> 
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <button id="open-menu-button" class="text-gray-600 hover:text-blue-600 lg:hidden"> 
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <a href="#" id="store-logo" class="text-base font-bold text-blue-600" onclick="showStoreView()">LogoLoja</a>
            <nav id="store-nav" class="hidden lg:flex items-center space-x-4"> 
                <a href="#" class="text-gray-600 hover:text-blue-500" onclick="showStoreView()">Início</a>
                <a href="https://wa.me/5531982684415" target="_blank" class="text-gray-600 hover:text-blue-500 flex items-center">
                    <svg class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.33 3.42 16.79L2.05 22L7.31 20.62C8.75 21.38 10.36 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 6.45 17.5 2 12.04 2ZM12.04 20.13C10.56 20.13 9.15 19.74 7.96 19.03L7.62 18.83L4.39 19.69L5.29 16.52L5.07 16.17C4.32 14.91 3.82 13.46 3.82 11.91C3.82 7.39 7.52 3.69 12.04 3.69C16.56 3.69 20.26 7.39 20.26 11.91C20.26 16.43 16.56 20.13 12.04 20.13ZM17.46 14.47C17.24 14.36 16.05 13.79 15.86 13.73C15.67 13.66 15.53 13.62 15.38 13.84C15.24 14.06 14.81 14.59 14.67 14.73C14.53 14.87 14.39 14.91 14.17 14.8C13.94 14.69 13.01 14.35 11.92 13.38C11.07 12.61 10.53 11.7 10.36 11.41C10.18 11.12 10.31 11 10.43 10.88C10.54 10.77 10.67 10.59 10.81 10.43C10.96 10.27 11 10.16 11.07 10.02C11.14 9.88 11.09 9.74 11.04 9.63C10.98 9.52 10.55 8.46 10.38 8.06C10.21 7.66 10.03 7.71 9.89 7.7C9.77 7.7 9.61 7.7 9.46 7.7C9.31 7.7 9.06 7.77 8.84 7.99C8.62 8.21 8.05 8.74 8.05 9.88C8.05 11.02 8.88 12.1 9.02 12.24C9.16 12.38 10.55 14.52 12.68 15.43C13.64 15.84 14.3 16.08 14.79 16.26C15.51 16.52 15.99 16.49 16.35 16.43C16.75 16.36 17.64 15.79 17.83 15.29C18.02 14.8 18.02 14.39 17.97 14.29C17.92 14.18 17.68 14.07 17.46 14.47Z"></path></svg>
                    WhatsApp
                </a>
                <a href="https://wa.me/5531982684415" target="_blank" id="contact-us-link-mainnav" class="text-gray-600 hover:text-blue-500 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    Fale Conosco (SAC)
                </a>
            </nav>
            <div class="lg:hidden w-6"></div> 
        </div>
    </header>

    <div class="main-content-area container mx-auto mt-4 gap-4 px-2 md:px-0">
        <div id="dynamic-content-area" class="w-full">
            
            <div id="store-view" class="flex flex-col lg:flex-row gap-4">
                <main id="main-product-list" class="w-full lg:w-3/4 bg-white p-6 rounded-lg shadow-lg main-content-section">
                    <div class="mb-6">
                        <input type="search" id="search-product-input" placeholder="Buscar produtos..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="category-filters-container" class="mb-6 flex flex-wrap gap-2"></div>
                    <h1 id="store-section-title" class="text-3xl font-bold mb-8 text-center text-gray-700">Nossos Produtos</h1>
                    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <p id="no-products-found" class="text-center text-gray-500 hidden">Nenhum produto encontrado.</p>
                </main>
                <aside id="cart-sidebar" class="w-full lg:w-1/4 bg-white p-6 rounded-lg shadow-lg lg:sticky lg:top-20 main-content-section" style="max-height: calc(100vh - 6rem); overflow-y: auto;">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Carrinho</h2>
                    <div id="cart-items-list"></div>
                    <div id="cart-total-section" class="mt-6 pt-4 border-t border-gray-300">
                        <div class="flex justify-between items-center font-semibold text-gray-700">
                            <span>Total:</span>
                            <span id="cart-total-value">R$ 0,00</span>
                        </div>
                        <button id="checkout-button-sidebar" class="w-full mt-4 bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600 transition duration-300">Ir para Pagamento</button>
                    </div>
                    <div id="cart-empty-message" class="text-center text-gray-500 mt-6">Seu carrinho está vazio.</div>
                </aside>
            </div>

            <div id="product-detail-view" class="hidden bg-white p-6 md:p-8 rounded-lg shadow-lg main-content-section"></div>
            
            <div id="admin-panel" class="hidden w-full bg-white p-6 rounded-lg shadow-lg main-content-section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-700">Painel do Administrador</h2>
                    <button id="back-to-store-button-admin" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300">
                        Ver Loja
                    </button>
                </div>

                <div class="mb-6 border-b pb-3 flex flex-wrap gap-2">
                    <button id="show-product-management-btn" class="admin-nav-button px-4 py-2 rounded-md text-sm font-medium">Gerenciar Produtos</button>
                    <button id="show-admin-orders-btn" class="admin-nav-button px-4 py-2 rounded-md text-sm font-medium">Gerenciar Pedidos</button>
                    <button id="show-cash-register-btn" class="admin-nav-button px-4 py-2 rounded-md text-sm font-medium">Caixa / Vendas</button>
                </div>

                <section id="product-management-section" class="mb-10">
                    <!-- Conteúdo de Gerenciar Produtos (existente) -->
                     <h3 class="text-2xl font-semibold mb-6 text-gray-600 border-b pb-3">Gerenciar Produtos</h3>
                    <form id="add-product-form" class="mb-4 p-6 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                        <h4 id="form-product-title" class="text-xl font-medium mb-4 text-gray-700">Adicionar Novo Produto</h4>
                        <input type="hidden" id="editing-product-id"> 
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="product-name" class="block text-sm font-medium text-gray-600 mb-1">Nome</label>
                                <input type="text" id="product-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div>
                                <label for="product-price" class="block text-sm font-medium text-gray-600 mb-1">Preço (R$)</label>
                                <input type="number" step="0.01" id="product-price" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div>
                                <label for="product-stock" class="block text-sm font-medium text-gray-600 mb-1">Estoque</label>
                                <input type="number" id="product-stock" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required min="0">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="product-category-select" class="block text-sm font-medium text-gray-600 mb-1">Categoria</label>
                            <select id="product-category-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                        <div class="mb-4">
                            <label for="new-product-category-input" class="block text-sm font-medium text-gray-600 mb-1">Ou Nova Categoria</label>
                            <div class="flex gap-2">
                                <input type="text" id="new-product-category-input" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Eletrônicos">
                                <button type="button" id="add-new-category-button" class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm py-2 px-3 rounded-md">Criar</button>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="product-image-url" class="block text-sm font-medium text-gray-600 mb-1">URL da Imagem Principal</label>
                            <input type="url" id="product-image-url" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="https://exemplo.com/imagem_principal.jpg">
                            <div id="image-drop-zone" class="mt-2 drop-zone">
                                <p>Arraste e solte a imagem principal aqui, ou clique para selecionar.</p>
                                <input type="file" id="product-image-file" class="hidden" accept="image/*">
                                <img id="image-preview" class="hidden product-image-preview" alt="Pré-visualização Imagem Principal"/>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="product-additional-image-urls" class="block text-sm font-medium text-gray-600 mb-1">URLs de Imagens Adicionais (separadas por vírgula)</label>
                            <textarea id="product-additional-image-urls" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="https://exemplo.com/img2.jpg, https://exemplo.com/img3.jpg"></textarea>
                        </div>
                        <div class="mb-6">
                            <label for="product-description" class="block text-sm font-medium text-gray-600 mb-1">Descrição</label>
                            <textarea id="product-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" id="submit-product-form-button" class="bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded-md">Adicionar Produto</button>
                            <button type="button" id="cancel-edit-product-button" class="hidden bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md">Cancelar Edição</button>
                        </div>
                    </form>
                    <div id="admin-add-product-feedback-container" class="hidden">
                        <p id="admin-add-product-feedback-message" class="font-semibold"></p>
                        <div class="mt-2">
                            <button id="admin-add-another-product-button" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-md mr-2">Adicionar outro produto?</button>
                            <button id="admin-view-store-after-add-button" class="bg-gray-500 hover:bg-gray-600 text-white text-sm py-1 px-3 rounded-md">Ver Loja</button>
                        </div>
                    </div>

                    <h4 class="text-xl font-medium mb-4 mt-8 text-gray-700">Produtos Cadastrados</h4>
                    <div id="admin-product-list" class="space-y-4">
                        <p id="no-admin-products" class="text-gray-500">Nenhum produto.</p>
                    </div>
                </section>

                <section id="admin-orders-management-section" class="hidden mb-10">
                    <h3 class="text-2xl font-semibold mb-6 text-gray-600 border-b pb-3">Gerenciar Pedidos</h3>
                    <div id="admin-orders-list" class="space-y-4">
                        <p class="text-gray-500">Nenhum pedido encontrado.</p>
                    </div>
                </section>

                <section id="admin-cash-register-section" class="hidden mb-10">
                    <!-- Conteúdo de Caixa / Vendas (existente) -->
                     <h3 class="text-2xl font-semibold mb-6 text-gray-600 border-b pb-3">Caixa / Relatório de Vendas</h3>
                    <div class="mb-4 flex flex-wrap gap-2">
                        <button id="filter-today" class="filter-btn bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-md text-sm">Hoje</button>
                        <button id="filter-week" class="filter-btn bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-md text-sm">Esta Semana</button>
                        <button id="filter-month" class="filter-btn bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-md text-sm">Este Mês</button>
                        <button id="filter-all-time" class="filter-btn bg-blue-500 text-white py-1 px-3 rounded-md text-sm active">Todo o Período</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-100 p-4 rounded-lg shadow">
                            <h4 class="text-blue-700 font-semibold">Total de Vendas (R$)</h4>
                            <p id="sales-summary-total" class="text-2xl font-bold text-blue-800">R$ 0,00</p>
                        </div>
                        <div class="bg-green-100 p-4 rounded-lg shadow">
                            <h4 class="text-green-700 font-semibold">Produtos Vendidos (Qtd.)</h4>
                            <p id="sales-summary-quantity" class="text-2xl font-bold text-green-800">0</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-xl font-medium mb-3 text-gray-700">Vendas por Produto</h4>
                        <div id="sales-product-breakdown" class="space-y-3">
                            <p class="text-gray-500">Nenhuma venda no período selecionado.</p>
                        </div>
                    </div>
                </section>
            </div>

            <div id="wishlist-view" class="hidden bg-white p-6 md:p-8 rounded-lg shadow-lg main-content-section">
                <h2 class="text-3xl font-bold mb-8 text-center text-gray-700">Minha Lista de Desejos</h2>
                <div id="wishlist-items-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Itens da lista de desejos -->
                </div>
                <p id="empty-wishlist-message" class="text-center text-gray-500 hidden">Sua lista de desejos está vazia.</p>
            </div>
            
            <div id="client-orders-view" class="hidden bg-white p-6 md:p-8 rounded-lg shadow-lg main-content-section">
                <h2 class="text-3xl font-bold mb-8 text-center text-gray-700">Meus Pedidos</h2>
                <div id="client-orders-list-container" class="space-y-6">
                     <!-- Pedidos do cliente aqui -->
                </div>
                 <p id="no-client-orders-message" class="text-center text-gray-500 hidden">Você ainda não fez nenhum pedido.</p>
            </div>


            <div id="checkout-view" class="hidden bg-white p-6 md:p-8 rounded-lg shadow-lg main-content-section">
                <div class="max-w-2xl mx-auto">
                    <button id="back-to-cart-button" class="mb-6 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md transition duration-300 inline-flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        Voltar ao Carrinho
                    </button>
                    <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Finalizar Compra</h2>
                    
                    <div id="checkout-delivery-options" class="mb-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">Modalidade de Compra</h3>
                        <div class="flex gap-4">
                            <label class="flex items-center p-3 border rounded-md cursor-pointer hover:border-blue-500 flex-1">
                                <input type="radio" name="deliveryOption" value="pickup" class="mr-2" checked>
                                Retirar na Loja
                            </label>
                            <label class="flex items-center p-3 border rounded-md cursor-pointer hover:border-blue-500 flex-1">
                                <input type="radio" name="deliveryOption" value="delivery" class="mr-2">
                                Entrega (Delivery)
                            </label>
                        </div>
                    </div>

                    <div id="checkout-delivery-address-form" class="hidden mb-6 p-4 border rounded-md bg-gray-50">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Endereço de Entrega</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="delivery-name" class="block text-sm font-medium text-gray-600 mb-1">Nome Completo</label>
                                <input type="text" id="delivery-name" class="w-full p-2 border border-gray-300 rounded-md" required>
                            </div>
                            <div>
                                <label for="delivery-phone" class="block text-sm font-medium text-gray-600 mb-1">Telefone</label>
                                <input type="tel" id="delivery-phone" class="w-full p-2 border border-gray-300 rounded-md" required>
                            </div>
                            <div class="md:col-span-2">
                                <label for="delivery-street" class="block text-sm font-medium text-gray-600 mb-1">Rua / Avenida</label>
                                <input type="text" id="delivery-street" class="w-full p-2 border border-gray-300 rounded-md" required>
                            </div>
                            <div>
                                <label for="delivery-number" class="block text-sm font-medium text-gray-600 mb-1">Número</label>
                                <input type="text" id="delivery-number" class="w-full p-2 border border-gray-300 rounded-md" required>
                            </div>
                             <div>
                                <label for="delivery-neighborhood" class="block text-sm font-medium text-gray-600 mb-1">Bairro</label>
                                <input type="text" id="delivery-neighborhood" class="w-full p-2 border border-gray-300 rounded-md" required>
                            </div>
                            <div>
                                <label for="delivery-city" class="block text-sm font-medium text-gray-600 mb-1">Cidade</label>
                                <input type="text" id="delivery-city" class="w-full p-2 border border-gray-300 rounded-md" required>
                            </div>
                            <div>
                                <label for="delivery-cep" class="block text-sm font-medium text-gray-600 mb-1">CEP</label>
                                <input type="text" id="delivery-cep" class="w-full p-2 border border-gray-300 rounded-md" required>
                            </div>
                            <div class="md:col-span-2">
                                <label for="delivery-reference" class="block text-sm font-medium text-gray-600 mb-1">Ponto de Referência (opcional)</label>
                                <input type="text" id="delivery-reference" class="w-full p-2 border border-gray-300 rounded-md">
                            </div>
                        </div>
                    </div>
                    
                    <div id="checkout-summary" class="mb-8 p-4 border rounded-md bg-gray-50">
                        <h3 class="text-xl font-semibold text-gray-700 mb-3">Resumo do Pedido</h3>
                        <div id="checkout-items-list" class="text-sm text-gray-600 space-y-1"></div>
                        <div class="mt-3 pt-3 border-t flex justify-between font-bold text-gray-700">
                            <span>Total do Pedido:</span>
                            <span id="checkout-total-value">R$ 0,00</span>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-xl font-semibold text-blue-600 mb-6 text-center">Pagar com Pix</h3>
                        <div class="flex flex-col items-center gap-6">
                            <div>
                                <p class="text-center text-gray-600 mb-2">Escaneie o QR Code abaixo:</p>
                                <img id="pix-qr-code-img" src="https://placehold.co/200x200/000000/FFFFFF?text=QR+Code+Pix" alt="QR Code Pix" class="pix-qr-code mx-auto rounded-md">
                            </div>
                            <div class="w-full max-w-md">
                                <p class="text-center text-gray-600 mb-2">Ou use a chave Pix (Copia e Cola):</p>
                                <div class="flex items-center border border-gray-300 rounded-md p-2 bg-gray-50">
                                    <input type="text" id="pix-key-text" class="flex-grow p-2 border-none bg-transparent focus:ring-0 text-sm text-gray-700" readonly>
                                    <button id="copy-pix-key-button" class="ml-2 bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-2 px-3 rounded-md transition duration-300">
                                        Copiar
                                    </button>
                                </div>
                                <p id="copy-feedback" class="text-xs text-green-600 mt-1 text-center hidden">Chave copiada!</p>
                            </div>
                            <button id="payment-confirmed-button" class="mt-6 w-full max-w-md bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-md transition duration-300 text-lg">
                                Já Fiz o Pagamento
                            </button>
                        </div>
                    </div>
                </div>
            </div>
             <div id="cart-view-dedicated" class="hidden bg-white p-6 md:p-8 rounded-lg shadow-lg main-content-section">
                <div class="max-w-3xl mx-auto">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-800">Meu Carrinho</h2>
                        <button id="continue-shopping-from-cart-view" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-300">
                            Continuar Comprando
                        </button>
                    </div>
                    <div id="cart-items-list-dedicated" class="space-y-4 mb-8"></div>
                    <div id="cart-empty-message-dedicated" class="text-center text-gray-500 py-8 hidden">
                        <p class="text-xl mb-4">Seu carrinho está vazio.</p>
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    </div>
                    <div id="cart-summary-dedicated" class="mt-6 pt-6 border-t border-gray-200">
                        <div class="flex justify-between items-center text-xl font-semibold text-gray-700 mb-6">
                            <span>Total:</span>
                            <span id="cart-total-value-dedicated">R$ 0,00</span>
                        </div>
                        <button id="checkout-button-dedicated" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-md transition duration-300 text-lg">
                            Ir para Pagamento
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-white text-center p-6 mt-12">
        <p>&copy; 2024 Minha Loja Virtual. Todos os direitos reservados.</p>
    </footer>

    <script>
        // --- ELEMENTOS DO DOM ---
        const openMenuButton = document.getElementById('open-menu-button');
        const closeMenuButton = document.getElementById('close-menu-button');
        const sideMenu = document.getElementById('side-menu');
        const sideMenuOverlay = document.getElementById('side-menu-overlay');

        // Admin Login
        const loginFormMenu = document.getElementById('login-form-menu');
        const loginFeedbackMenu = document.getElementById('login-feedback-menu');
        const loginSectionMenu = document.getElementById('login-section-menu');
        const adminInfoSectionMenu = document.getElementById('admin-info-section-menu');
        const adminEmailDisplayMenu = document.getElementById('admin-email-display-menu');
        const adminLogoutButtonMenu = document.getElementById('admin-logout-button-menu');
        const adminPanelLinkSideMenu = document.getElementById('admin-panel-link-side-menu');
        
        // Client Login
        const clientLoginSectionMenu = document.getElementById('client-login-section-menu');
        const clientLoginFormMenu = document.getElementById('client-login-form-menu');
        const clientLoginFeedbackMenu = document.getElementById('client-login-feedback-menu');
        const clientInfoSectionMenu = document.getElementById('client-info-section-menu');
        const clientEmailDisplayMenu = document.getElementById('client-email-display-menu');
        const clientLogoutButtonMenu = document.getElementById('client-logout-button-menu');
        const registerClientLink = document.getElementById('register-client-link');
        const myWishlistLinkMenu = document.getElementById('my-wishlist-link-menu');
        const myOrdersLinkMenu = document.getElementById('my-orders-link-menu');


        const dynamicContentArea = document.getElementById('dynamic-content-area');
        const storeView = document.getElementById('store-view');
        const adminPanel = document.getElementById('admin-panel');
        const productDetailView = document.getElementById('product-detail-view');
        // const ordersView = document.getElementById('orders-view'); // Original orders view, might be replaced or repurposed
        const clientOrdersView = document.getElementById('client-orders-view');
        const clientOrdersListContainer = document.getElementById('client-orders-list-container');
        const noClientOrdersMessage = document.getElementById('no-client-orders-message');

        const wishlistView = document.getElementById('wishlist-view');
        const wishlistItemsContainer = document.getElementById('wishlist-items-container');
        const emptyWishlistMessage = document.getElementById('empty-wishlist-message');
        
        const checkoutView = document.getElementById('checkout-view');
        const cartViewDedicated = document.getElementById('cart-view-dedicated');

        const backToStoreButtonAdmin = document.getElementById('back-to-store-button-admin');

        // Admin Panel Sections & Nav
        const productManagementSection = document.getElementById('product-management-section');
        const adminOrdersManagementSection = document.getElementById('admin-orders-management-section');
        const adminCashRegisterSection = document.getElementById('admin-cash-register-section');
        
        const showProductManagementBtn = document.getElementById('show-product-management-btn');
        const showAdminOrdersBtn = document.getElementById('show-admin-orders-btn');
        const showCashRegisterBtn = document.getElementById('show-cash-register-btn');
        const adminOrdersListContainer = document.getElementById('admin-orders-list');


        const addProductForm = document.getElementById('add-product-form');
        const adminProductListContainer = document.getElementById('admin-product-list');
        const noAdminProductsMessage = document.getElementById('no-admin-products');
        // const addAdminForm = document.getElementById('add-admin-form'); // Not used in this update
        // const adminUsersListContainer = document.getElementById('admin-users-list'); // Not used in this update
        const formProductTitle = document.getElementById('form-product-title');
        const submitProductFormButton = document.getElementById('submit-product-form-button');
        const cancelEditProductButton = document.getElementById('cancel-edit-product-button');
        const editingProductIdInput = document.getElementById('editing-product-id');
        const adminAddProductFeedbackContainer = document.getElementById('admin-add-product-feedback-container');
        const adminAddProductFeedbackMessage = document.getElementById('admin-add-product-feedback-message');
        const adminAddAnotherProductButton = document.getElementById('admin-add-another-product-button');
        const adminViewStoreAfterAddButton = document.getElementById('admin-view-store-after-add-button');

        const productStockInput = document.getElementById('product-stock');
        const productImageMainUrlInput = document.getElementById('product-image-url');
        const productAdditionalImageUrlsInput = document.getElementById('product-additional-image-urls');
        
        const imageDropZone = document.getElementById('image-drop-zone');
        const productImageFileInput = document.getElementById('product-image-file');
        const imagePreview = document.getElementById('image-preview');
        let uploadedImageFile = null; 

        const backToCartButton = document.getElementById('back-to-cart-button');
        const pixKeyTextElement = document.getElementById('pix-key-text');
        const copyPixKeyButton = document.getElementById('copy-pix-key-button');
        const copyFeedbackElement = document.getElementById('copy-feedback');
        const paymentConfirmedButton = document.getElementById('payment-confirmed-button');
        const checkoutItemsList = document.getElementById('checkout-items-list');
        const checkoutTotalValue = document.getElementById('checkout-total-value');
        const checkoutDeliveryOptions = document.getElementById('checkout-delivery-options');
        const checkoutDeliveryAddressForm = document.getElementById('checkout-delivery-address-form');


        const cartItemsListDedicated = document.getElementById('cart-items-list-dedicated');
        const cartTotalValueDedicated = document.getElementById('cart-total-value-dedicated');
        const cartEmptyMessageDedicated = document.getElementById('cart-empty-message-dedicated');
        const checkoutButtonDedicated = document.getElementById('checkout-button-dedicated');
        const continueShoppingFromCartViewButton = document.getElementById('continue-shopping-from-cart-view');
        const cartSummaryDedicated = document.getElementById('cart-summary-dedicated');

        const searchProductInput = document.getElementById('search-product-input');
        const categoryFiltersContainer = document.getElementById('category-filters-container');
        const storeSectionTitle = document.getElementById('store-section-title');
        const productGrid = document.getElementById('product-grid');
        const noProductsFoundMessage = document.getElementById('no-products-found');
        const productCategorySelect = document.getElementById('product-category-select');
        const newProductCategoryInput = document.getElementById('new-product-category-input');
        const addNewCategoryButton = document.getElementById('add-new-category-button');

        const filterTodayButton = document.getElementById('filter-today');
        const filterWeekButton = document.getElementById('filter-week');
        const filterMonthButton = document.getElementById('filter-month');
        const filterAllTimeButton = document.getElementById('filter-all-time');
        const salesSummaryTotalEl = document.getElementById('sales-summary-total');
        const salesSummaryQuantityEl = document.getElementById('sales-summary-quantity');
        const salesProductBreakdownEl = document.getElementById('sales-product-breakdown');


        // --- ESTADO DA APLICAÇÃO ---
        let categories = [ 
            { id: 'cat0', name: 'Todas as Categorias' }, 
            { id: 'cat1', name: 'Destaques da Semana' },
            { id: 'cat2', name: 'Novidades' },
            { id: 'cat3', name: 'Mais Vendidos' }
        ];
        let products = [ 
            { id: 'prod1', name: "Produto Exemplo Alfa", categoryId: 'cat2', price: 99.90, imageUrls: ["https://placehold.co/400x300/E0E7FF/4F46E5?text=Produto+Alfa+1", "https://placehold.co/400x300/E0E7FF/4F46E5?text=Produto+Alfa+2"], description: "Descrição detalhada do Produto Exemplo Alfa.", stock: 10, reviews: [] },
            { id: 'prod2', name: "Produto Exemplo Beta", categoryId: 'cat1', price: 129.50, imageUrls: ["https://placehold.co/400x300/DBEAFE/1D4ED8?text=Produto+Beta"], description: "O Produto Exemplo Beta combina design moderno com funcionalidade superior.", stock: 5, reviews: [] },
            { id: 'prod3', name: "Produto Exemplo Gama", categoryId: 'cat2', price: 75.00, imageUrls: ["https://placehold.co/400x300/BFDBFE/1E40AF?text=Produto+Gama"], description: "Conheça o Produto Exemplo Gama.", stock: 0, reviews: [] },
            { id: 'prod4', name: "Produto Exemplo Delta", categoryId: 'cat3', price: 210.00, imageUrls: ["https://placehold.co/400x300/93C5FD/1C3FAA?text=Produto+Delta", "https://placehold.co/400x300/93C5FD/1C3FAA?text=Produto+Delta+Img2"], description: "Produto Exemplo Delta: robustez e tecnologia.", stock: 20, reviews: [] },
            { id: 'prod5', name: "Produto Exemplo Epsilon", categoryId: 'cat2', price: 45.99, imageUrls: ["https://placehold.co/400x300/60A5FA/1B3A9A?text=Produto+Epsilon"], description: "Leve e compacto, o Produto Exemplo Epsilon.", stock: 15, reviews: [] },
            { id: 'prod6', name: "Produto Exemplo Zeta", categoryId: 'cat1', price: 88.80, imageUrls: ["https://placehold.co/400x300/3B82F6/1A358A?text=Produto+Zeta"], description: "O Produto Exemplo Zeta oferece um excelente custo-benefício.", stock: 8, reviews: [] }
        ];
        let adminUsers = [
            { email: "admin@loja.com", password: "admin123" } // Admin padrão
        ];
        let clients = [
            { id: 'client1', email: "vini@cliente.com", password: "1234", name: "Vinicius Cliente", phone: "31999998888", wishlist: [], orders: [] }
        ];
        let cart = [];
        let salesRecords = []; 
        let isAdminLoggedIn = false;
        let currentAdminEmail = null;
        let loggedInClient = null; 
        let activeFeedbackTimeout = null; 
        let currentCategoryFilter = 'cat0'; 
        let currentSearchTerm = '';
        let isEditingProduct = false;
        let currentDetailImageIndex = 0;
        let currentAdminPanelSection = 'product-management'; 
        let currentSalesFilterPeriod = 'all-time';


        // --- CONTROLE DO MENU LATERAL ---
        function openSideMenu() {
            sideMenu.classList.add('open');
            sideMenuOverlay.classList.remove('hidden');
            sideMenuOverlay.style.opacity = '1';
        }

        function closeSideMenu() {
            sideMenu.classList.remove('open');
            sideMenuOverlay.style.opacity = '0';
            setTimeout(() => {
                sideMenuOverlay.classList.add('hidden');
            }, 300); 
        }

        openMenuButton?.addEventListener('click', openSideMenu);
        closeMenuButton?.addEventListener('click', closeSideMenu);
        sideMenuOverlay?.addEventListener('click', closeSideMenu);
        
        adminPanelLinkSideMenu?.addEventListener('click', (e) => {
            e.preventDefault();
            if(isAdminLoggedIn) {
                showAdminView(currentAdminEmail, currentAdminPanelSection); 
            }
            closeSideMenu();
        });
        myWishlistLinkMenu?.addEventListener('click', (e) => {
            e.preventDefault();
            if(loggedInClient) showWishlistView();
            closeSideMenu();
        });
        myOrdersLinkMenu?.addEventListener('click', (e) => {
            e.preventDefault();
            if(loggedInClient) showClientOrdersView();
            closeSideMenu();
        });


        // --- FUNÇÕES DE RENDERIZAÇÃO E CONTROLE DE VIEW ---
        function setActiveView(activeViewElementId) {
            const views = [storeView, adminPanel, productDetailView, clientOrdersView, wishlistView, checkoutView, cartViewDedicated];
            views.forEach(view => { 
                if(view) view.classList.add('hidden');
            });
            const activeView = document.getElementById(activeViewElementId);
            if(activeView) activeView.classList.remove('hidden');
        }
        
        function renderStoreProducts() {
            if (!productGrid || !noProductsFoundMessage || !storeSectionTitle) return;
            productGrid.innerHTML = '';
            let filteredProducts = products;

            if (currentCategoryFilter !== 'cat0') {
                filteredProducts = filteredProducts.filter(p => p.categoryId === currentCategoryFilter);
            }
            if (currentSearchTerm) {
                const searchTermLower = currentSearchTerm.toLowerCase();
                filteredProducts = filteredProducts.filter(p => 
                    p.name.toLowerCase().includes(searchTermLower) || 
                    p.description.toLowerCase().includes(searchTermLower)
                );
            }
            
            const selectedCategory = categories.find(c => c.id === currentCategoryFilter);
            storeSectionTitle.textContent = selectedCategory ? selectedCategory.name : "Nossos Produtos";

            if (filteredProducts.length === 0) {
                noProductsFoundMessage.classList.remove('hidden');
            } else {
                noProductsFoundMessage.classList.add('hidden');
                filteredProducts.forEach((product) => {
                    const productCard = document.createElement('div');
                    productCard.className = "product-card bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm flex flex-col items-center text-center";
                    productCard.dataset.id = product.id;
                    
                    const isOutOfStock = product.stock <= 0;
                    const mainImageUrl = product.imageUrls && product.imageUrls.length > 0 ? product.imageUrls[0] : 'https://placehold.co/300x200/cccccc/969696?text=Sem+Imagem';
                    const isInWishlist = loggedInClient && loggedInClient.wishlist.includes(product.id);

                    productCard.innerHTML = `
                        <button class="wishlist-button ${isInWishlist ? 'active' : ''}" data-product-id="${product.id}" title="Adicionar à Lista de Desejos">
                            <svg viewBox="0 0 24 24" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                        </button>
                        <div class="relative w-full h-48 mb-4 product-image-container">
                            <img src="${mainImageUrl}" alt="Imagem de ${product.name}" class="w-full h-full object-cover rounded-md product-image">
                            ${isOutOfStock ? '<div class="out-of-stock-overlay">Fora de Estoque</div>' : ''}
                        </div>
                        <h3 class="text-lg font-medium text-gray-700 mb-1 product-name">${product.name}</h3>
                        <p class="text-xl font-bold text-blue-600 mb-3 product-price">R$ ${product.price.toFixed(2)}</p>
                        <p class="text-xs text-gray-500 mb-2 product-description h-10 overflow-hidden" title="${product.description || ''}">${(product.description || 'Sem descrição detalhada.').substring(0,50)}...</p>
                        <button class="mt-auto w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition duration-300 add-to-cart-button-list" ${isOutOfStock ? 'disabled' : ''}>
                            ${isOutOfStock ? 'Fora de Estoque' : 'Adicionar ao Carrinho'}
                        </button>
                        <div class="add-to-cart-feedback hidden mt-2 text-sm w-full"></div>
                    `;
                    productCard.querySelector('.product-image-container').addEventListener('click', (e) => {
                         // Evita que o clique na imagem dispare o clique no card se o botão de wishlist foi clicado
                        if (e.target.closest('.wishlist-button')) return;
                        showProductDetailView(product.id);
                    });
                     productCard.querySelector('.wishlist-button').addEventListener('click', (e) => {
                        e.stopPropagation(); // Impede que o clique no botão de wishlist abra os detalhes do produto
                        toggleWishlistItem(product.id, e.currentTarget);
                    });
                    productGrid.appendChild(productCard);
                });
            }
            addEventListenersToAddToCartButtons();
        }

        function renderCategoryFilters() {
            if (!categoryFiltersContainer) return;
            categoryFiltersContainer.innerHTML = '';
            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = `category-filter-button px-4 py-2 border rounded-md text-sm font-medium hover:bg-blue-500 hover:text-white transition-colors ${category.id === currentCategoryFilter ? 'active' : 'bg-white text-gray-700 border-gray-300'}`;
                button.textContent = category.name;
                button.dataset.categoryId = category.id;
                button.addEventListener('click', () => {
                    currentCategoryFilter = category.id;
                    renderCategoryFilters(); 
                    renderStoreProducts();
                });
                categoryFiltersContainer.appendChild(button);
            });
        }

        function populateCategoryDropdown() {
            if (!productCategorySelect) return;
            productCategorySelect.innerHTML = '';
            categories.filter(c => c.id !== 'cat0').forEach(category => { 
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                productCategorySelect.appendChild(option);
            });
        }

        function updateProductDetailImageView(product) {
            const mainImageElement = document.getElementById('product-detail-main-image');
            const indicatorsContainer = document.getElementById('product-detail-image-indicators');
            const carouselControls = document.getElementById('product-detail-carousel-controls');

            if (!mainImageElement || !indicatorsContainer || !carouselControls || !product.imageUrls || product.imageUrls.length === 0) {
                if(mainImageElement) mainImageElement.src = 'https://placehold.co/600x400/cccccc/969696?text=Sem+Imagem';
                if(carouselControls) carouselControls.classList.add('hidden');
                if(indicatorsContainer) indicatorsContainer.innerHTML = '';
                return;
            }
            
            mainImageElement.src = product.imageUrls[currentDetailImageIndex] || 'https://placehold.co/600x400/cccccc/969696?text=Sem+Imagem';
            mainImageElement.alt = product.name + (product.imageUrls.length > 1 ? ` - Imagem ${currentDetailImageIndex + 1}` : '');

            indicatorsContainer.innerHTML = '';
            if (product.imageUrls.length > 1) {
                carouselControls.classList.remove('hidden');
                product.imageUrls.forEach((_, index) => {
                    const dot = document.createElement('button');
                    dot.className = `image-indicator-dot ${index === currentDetailImageIndex ? 'active' : ''}`;
                    dot.addEventListener('click', () => {
                        currentDetailImageIndex = index;
                        updateProductDetailImageView(product);
                    });
                    indicatorsContainer.appendChild(dot);
                });
            } else {
                carouselControls.classList.add('hidden');
            }
        }

        function renderProductReviews(productId) {
            const reviewsContainer = document.getElementById('product-reviews-container');
            if (!reviewsContainer) return;

            const product = products.find(p => p.id === productId);
            reviewsContainer.innerHTML = '<h4 class="text-lg font-semibold text-gray-700 mb-3">Avaliações de Clientes</h4>';

            if (!product || !product.reviews || product.reviews.length === 0) {
                reviewsContainer.innerHTML += '<p class="text-gray-500 text-sm">Este produto ainda não possui avaliações.</p>';
                return;
            }

            let totalRating = 0;
            product.reviews.forEach(review => totalRating += review.rating);
            const averageRating = totalRating / product.reviews.length;

            reviewsContainer.innerHTML += `
                <div class="mb-4">
                    <p class="text-yellow-500 text-xl font-bold">${'★'.repeat(Math.round(averageRating))}${'☆'.repeat(5 - Math.round(averageRating))} 
                    <span class="text-sm text-gray-600 ml-1">(${averageRating.toFixed(1)} de 5 estrelas) - ${product.reviews.length} avaliações</span></p>
                </div>
            `;

            const reviewsList = document.createElement('div');
            reviewsList.className = 'space-y-4';
            product.reviews.forEach(review => {
                const reviewDiv = document.createElement('div');
                reviewDiv.className = 'p-3 border rounded-md bg-gray-50';
                reviewDiv.innerHTML = `
                    <div class="flex items-center mb-1">
                        <p class="text-yellow-500 font-semibold">${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}</p>
                        <p class="text-xs text-gray-500 ml-2">- ${new Date(review.date).toLocaleDateString('pt-BR')}</p>
                    </div>
                    <p class="text-sm text-gray-700">${review.comment || '<i>Sem comentário.</i>'}</p>
                `;
                reviewsList.appendChild(reviewDiv);
            });
            reviewsContainer.appendChild(reviewsList);
        }


        function showProductDetailView(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || !productDetailView) return;

            currentDetailImageIndex = 0; 
            const isOutOfStock = product.stock <= 0;
            const firstImage = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : 'https://placehold.co/600x400/cccccc/969696?text=Sem+Imagem';
            const isInWishlist = loggedInClient && loggedInClient.wishlist.includes(product.id);

            productDetailView.innerHTML = `
                <button id="back-to-store-from-detail" class="mb-6 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md transition duration-300 inline-flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Voltar para Loja
                </button>
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="md:w-1/2 product-detail-image-container">
                        <img id="product-detail-main-image" src="${firstImage}" alt="${product.name}" class="product-detail-image">
                        <div id="product-detail-carousel-controls" class="absolute inset-0 flex items-center justify-between p-2 ${product.imageUrls && product.imageUrls.length > 1 ? '' : 'hidden'}">
                            <button id="prev-image-btn" class="carousel-button">&lt;</button>
                            <button id="next-image-btn" class="carousel-button">&gt;</button>
                        </div>
                        <div id="product-detail-image-indicators" class="image-indicators"></div>
                         ${isOutOfStock ? '<div class="out-of-stock-overlay">Fora de Estoque</div>' : ''}
                    </div>
                    <div class="md:w-1/2 flex flex-col">
                        <div class="flex justify-between items-start">
                            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-3">${product.name}</h1>
                            <button class="wishlist-button ${isInWishlist ? 'active' : ''} ml-4" data-product-id="${product.id}" title="Adicionar à Lista de Desejos">
                                <svg viewBox="0 0 24 24" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                            </button>
                        </div>
                        <p class="text-2xl font-semibold text-blue-600 mb-5">R$ ${product.price.toFixed(2)}</p>
                        <p class="text-gray-600 mb-6 leading-relaxed">${product.description}</p>
                        ${isOutOfStock ? '<p class="text-red-500 font-bold text-lg mt-auto mb-3">Produto Indisponível</p>' : ''}
                        <button data-id="${product.id}" class="mt-auto w-full md:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-md transition duration-300 text-lg add-to-cart-button-detail" ${isOutOfStock ? 'disabled' : ''}>
                            ${isOutOfStock ? 'Fora de Estoque' : 'Adicionar ao Carrinho'}
                        </button>
                        <div class="add-to-cart-feedback hidden mt-2 text-sm"></div>
                    </div>
                </div>
                <div id="product-reviews-container" class="mt-10 pt-6 border-t">
                    <!-- Avaliações serão renderizadas aqui -->
                </div>
            `;
            setActiveView('product-detail-view');
            updateProductDetailImageView(product); 
            renderProductReviews(productId);

            document.getElementById('back-to-store-from-detail')?.addEventListener('click', () => setActiveView('store-view'));
            
            document.getElementById('prev-image-btn')?.addEventListener('click', () => {
                if (!product.imageUrls || product.imageUrls.length === 0) return;
                currentDetailImageIndex = (currentDetailImageIndex - 1 + product.imageUrls.length) % product.imageUrls.length;
                updateProductDetailImageView(product);
            });
            document.getElementById('next-image-btn')?.addEventListener('click', () => {
                 if (!product.imageUrls || product.imageUrls.length === 0) return;
                currentDetailImageIndex = (currentDetailImageIndex + 1) % product.imageUrls.length;
                updateProductDetailImageView(product);
            });

            const addToCartDetailButton = productDetailView.querySelector('.add-to-cart-button-detail');
            addToCartDetailButton?.addEventListener('click', function() {
                const prodId = this.dataset.id;
                const productToAdd = products.find(p => p.id === prodId);
                if (productToAdd) {
                    handleAddToCart(productToAdd, this); 
                }
            });
             productDetailView.querySelector('.wishlist-button').addEventListener('click', (e) => {
                toggleWishlistItem(product.id, e.currentTarget);
            });
            closeSideMenu();
        }
        
        function showAdminPanelSection(sectionId) {
            currentAdminPanelSection = sectionId;
            [productManagementSection, adminOrdersManagementSection, adminCashRegisterSection].forEach(section => {
                if (section) section.classList.add('hidden');
            });
            [showProductManagementBtn, showAdminOrdersBtn, showCashRegisterBtn].forEach(button => {
                 if(button) button.classList.remove('active');
            });

            if (sectionId === 'product-management') {
                if(productManagementSection) productManagementSection.classList.remove('hidden');
                if(showProductManagementBtn) showProductManagementBtn.classList.add('active');
            } else if (sectionId === 'admin-orders') {
                if(adminOrdersManagementSection) adminOrdersManagementSection.classList.remove('hidden');
                if(showAdminOrdersBtn) showAdminOrdersBtn.classList.add('active');
                renderAdminOrders();
            } else if (sectionId === 'cash-register') {
                if(adminCashRegisterSection) adminCashRegisterSection.classList.remove('hidden');
                if(showCashRegisterBtn) showCashRegisterBtn.classList.add('active');
                renderCashRegisterDisplay(currentSalesFilterPeriod); 
            }
        }

        showProductManagementBtn?.addEventListener('click', () => showAdminPanelSection('product-management'));
        showAdminOrdersBtn?.addEventListener('click', () => showAdminPanelSection('admin-orders'));
        showCashRegisterBtn?.addEventListener('click', () => showAdminPanelSection('cash-register'));

        function showAdminView(adminEmail, sectionToShow = 'product-management') {
            isAdminLoggedIn = true;
            currentAdminEmail = adminEmail;
            setActiveView('admin-panel');
            
            loginSectionMenu.classList.add('hidden');
            adminInfoSectionMenu.classList.remove('hidden');
            adminPanelLinkSideMenu.classList.remove('hidden');
            adminEmailDisplayMenu.textContent = adminEmail;
            
            document.getElementById('store-logo').textContent = "Painel Admin";
            document.getElementById('store-nav').classList.add('hidden');
            openMenuButton.classList.add('lg:hidden'); 
            
            populateCategoryDropdown();
            renderAdminProducts();
            // renderAdminUsers(); // Removido pois não está sendo usado/pedido nesta atualização
            showAdminPanelSection(sectionToShow);
            resetProductForm(); 
            closeSideMenu();
        }

        function showStoreView() {
            setActiveView('store-view');
            if (!isAdminLoggedIn) {
                loginSectionMenu.classList.remove('hidden'); 
                adminInfoSectionMenu.classList.add('hidden'); 
                adminPanelLinkSideMenu.classList.add('hidden');
                document.getElementById('store-logo').textContent = "LogoLoja";
            } else { // Admin está logado, mas vendo a loja
                loginSectionMenu.classList.add('hidden');
                adminInfoSectionMenu.classList.remove('hidden');
                adminPanelLinkSideMenu.classList.remove('hidden');
                adminEmailDisplayMenu.textContent = currentAdminEmail;
                document.getElementById('store-logo').textContent = "LogoLoja (Admin)";
            }
             // Lógica para menu do cliente
            if (!loggedInClient) {
                clientLoginSectionMenu.classList.remove('hidden');
                clientInfoSectionMenu.classList.add('hidden');
            } else {
                clientLoginSectionMenu.classList.add('hidden');
                clientInfoSectionMenu.classList.remove('hidden');
                clientEmailDisplayMenu.textContent = loggedInClient.email;
            }

            document.getElementById('store-nav').classList.remove('hidden'); 
            openMenuButton.classList.remove('lg:hidden'); 
            renderCategoryFilters();
            renderStoreProducts(); 
            closeSideMenu();
        }
        
        function showWishlistView() {
            if (!loggedInClient) {
                showModal("Acesso Negado", "Faça login para ver sua lista de desejos.", null, false);
                return;
            }
            setActiveView('wishlist-view');
            wishlistItemsContainer.innerHTML = '';
            if (loggedInClient.wishlist.length === 0) {
                emptyWishlistMessage.classList.remove('hidden');
            } else {
                emptyWishlistMessage.classList.add('hidden');
                loggedInClient.wishlist.forEach(productId => {
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        const productCard = createProductCard(product, true); // true para isWishlistView
                        wishlistItemsContainer.appendChild(productCard);
                    }
                });
            }
            closeSideMenu();
        }

        function showClientOrdersView() {
            if (!loggedInClient) {
                showModal("Acesso Negado", "Faça login para ver seus pedidos.", null, false);
                return;
            }
            setActiveView('client-orders-view');
            renderClientOrders();
            closeSideMenu();
        }


        function showCheckoutView() {
            if (!loggedInClient) {
                showModal("Login Necessário", "Por favor, faça login como cliente para prosseguir com a compra.", () => {
                    // Poderia redirecionar para o menu de login ou abrir um modal de login aqui
                    openSideMenu(); // Abre o menu para o cliente logar
                }, false);
                return;
            }
            if (cart.length === 0) {
                showCartViewDedicated(); 
                return;
            }
            setActiveView('checkout-view');
            pixKeyTextElement.value = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            checkoutItemsList.innerHTML = '';
            let total = 0;
            cart.forEach(item => {
                const listItem = document.createElement('div');
                listItem.className = 'flex justify-between';
                listItem.innerHTML = `<span>${item.name} (x${item.quantity})</span> <span>R$ ${(item.price * item.quantity).toFixed(2)}</span>`;
                checkoutItemsList.appendChild(listItem);
                total += item.price * item.quantity;
            });
            checkoutTotalValue.textContent = `R$ ${total.toFixed(2)}`;

            // Reset e esconde formulário de endereço por padrão
            checkoutDeliveryAddressForm.classList.add('hidden');
            document.getElementById('delivery-name').value = loggedInClient.name || '';
            document.getElementById('delivery-phone').value = loggedInClient.phone || '';
            // Limpar outros campos de endereço se necessário
            ['delivery-street', 'delivery-number', 'delivery-neighborhood', 'delivery-city', 'delivery-cep', 'delivery-reference'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });

            document.querySelectorAll('input[name="deliveryOption"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'delivery') {
                        checkoutDeliveryAddressForm.classList.remove('hidden');
                    } else {
                        checkoutDeliveryAddressForm.classList.add('hidden');
                    }
                });
                 // Garante que o estado inicial do formulário de endereço seja respeitado
                if (radio.value === 'delivery' && radio.checked) {
                    checkoutDeliveryAddressForm.classList.remove('hidden');
                }
            });

            closeSideMenu();
        }

        function showCartViewDedicated() {
            setActiveView('cart-view-dedicated');
            cartItemsListDedicated.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                cartEmptyMessageDedicated.classList.remove('hidden');
                cartSummaryDedicated.classList.add('hidden'); 
            } else {
                cartEmptyMessageDedicated.classList.add('hidden');
                cartSummaryDedicated.classList.remove('hidden'); 
                cart.forEach((item) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex justify-between items-center p-4 border-b border-gray-200';
                    const mainImageUrl = item.imageUrls && item.imageUrls.length > 0 ? item.imageUrls[0] : 'https://placehold.co/60x60/cccccc/969696?text=N/A';
                    itemElement.innerHTML = `
                        <div class="flex items-center">
                            <img src="${mainImageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md mr-4">
                            <div>
                                <h4 class="font-semibold text-gray-700">${item.name}</h4>
                                <p class="text-sm text-gray-500">Quantidade: ${item.quantity}</p>
                                <p class="text-sm text-blue-600">Preço: R$ ${item.price.toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-gray-700">R$ ${(item.price * item.quantity).toFixed(2)}</p>
                            <button class="text-red-500 hover:text-red-700 text-xs mt-1 remove-from-cart-button-dedicated" data-id="${item.id}">Remover</button>
                        </div>
                    `;
                    cartItemsListDedicated.appendChild(itemElement);
                    total += item.price * item.quantity;
                });
            }
            cartTotalValueDedicated.textContent = `R$ ${total.toFixed(2)}`;
            addEventListenersToRemoveFromCartButtonsDedicated();
            closeSideMenu();
        }

        // --- SISTEMA DE LOGIN (ADMIN E CLIENTE) ---
        if (loginFormMenu) { // Admin Login
            loginFormMenu.addEventListener('submit', function(event) {
                event.preventDefault();
                const email = document.getElementById('email-menu').value;
                const password = document.getElementById('senha-menu').value;
                const admin = adminUsers.find(user => user.email === email && user.password === password);
                loginFeedbackMenu.innerHTML = '';
                loginFeedbackMenu.classList.remove('hidden', 'feedback-success', 'feedback-error');
                if (admin) {
                    loginFeedbackMenu.textContent = "Login Admin bem-sucedido!";
                    loginFeedbackMenu.classList.add('feedback-message', 'feedback-success');
                    setTimeout(() => {
                        showAdminView(admin.email, 'product-management'); 
                        loginFeedbackMenu.classList.add('hidden'); 
                    }, 500); 
                } else {
                    loginFeedbackMenu.textContent = "Email ou senha de Admin inválidos.";
                    loginFeedbackMenu.classList.add('feedback-message', 'feedback-error');
                }
            });
        }

        clientLoginFormMenu?.addEventListener('submit', function(event) {
            event.preventDefault();
            const email = document.getElementById('client-email-menu').value;
            const password = document.getElementById('client-senha-menu').value;
            const client = clients.find(c => c.email === email && c.password === password);
            
            clientLoginFeedbackMenu.textContent = '';
            if (client) {
                loggedInClient = client;
                clientLoginFeedbackMenu.textContent = "Login bem-sucedido!";
                clientLoginFeedbackMenu.className = 'text-xs mt-1 text-green-600';
                updateClientMenu();
                renderStoreProducts(); // Re-render para atualizar botões de wishlist
                setTimeout(() => { 
                    clientLoginFeedbackMenu.textContent = '';
                    closeSideMenu();
                 }, 1000);
            } else {
                clientLoginFeedbackMenu.textContent = "Email ou senha de cliente inválidos.";
                clientLoginFeedbackMenu.className = 'text-xs mt-1 text-red-600';
            }
        });

        registerClientLink?.addEventListener('click', (e) => {
            e.preventDefault();
            // Simples prompt para cadastro, idealmente seria um formulário
            const email = prompt("Digite seu email para cadastro:");
            const password = prompt("Digite sua senha:");
            const name = prompt("Digite seu nome completo:");
            if (email && password && name) {
                if (clients.find(c => c.email === email)) {
                    showModal("Erro de Cadastro", "Este email já está cadastrado.", null, false);
                } else {
                    const newClient = { id: `client${clients.length + 1}${Date.now()}`, email, password, name, phone: '', wishlist: [], orders: [] };
                    clients.push(newClient);
                    loggedInClient = newClient; // Loga automaticamente após cadastro
                    updateClientMenu();
                    showModal("Cadastro Realizado", "Cadastro realizado com sucesso! Você já está logado.", null, false);
                    closeSideMenu();
                }
            } else {
                showModal("Cadastro Cancelado", "Informações incompletas para cadastro.", null, false);
            }
        });


        function updateClientMenu() {
            if (loggedInClient) {
                clientLoginSectionMenu.classList.add('hidden');
                clientInfoSectionMenu.classList.remove('hidden');
                clientEmailDisplayMenu.textContent = loggedInClient.email;
            } else {
                clientLoginSectionMenu.classList.remove('hidden');
                clientInfoSectionMenu.classList.add('hidden');
            }
        }
        
        clientLogoutButtonMenu?.addEventListener('click', () => {
            loggedInClient = null;
            updateClientMenu();
            renderStoreProducts(); // Re-render para atualizar botões de wishlist
            showModal("Logout", "Você foi desconectado.", null, false);
            showStoreView(); // Volta para a loja
        });


        adminLogoutButtonMenu?.addEventListener('click', () => {
            isAdminLoggedIn = false; 
            currentAdminEmail = null;
            showStoreView(); 
        });
        backToStoreButtonAdmin?.addEventListener('click', showStoreView);
        backToCartButton?.addEventListener('click', () => setActiveView('cart-view-dedicated')); 
        checkoutButtonDedicated?.addEventListener('click', showCheckoutView);
        continueShoppingFromCartViewButton?.addEventListener('click', () => setActiveView('store-view'));

        function resetProductForm() {
            addProductForm.reset();
            formProductTitle.textContent = "Adicionar Novo Produto";
            submitProductFormButton.textContent = "Adicionar Produto";
            submitProductFormButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            submitProductFormButton.classList.add('bg-green-600', 'hover:bg-green-700');
            cancelEditProductButton.classList.add('hidden');
            editingProductIdInput.value = '';
            imagePreview.classList.add('hidden');
            imagePreview.src = '';
            uploadedImageFile = null;
            productAdditionalImageUrlsInput.value = ''; 
            adminAddProductFeedbackContainer.classList.add('hidden');
            isEditingProduct = false;
        }

        cancelEditProductButton?.addEventListener('click', resetProductForm);
        adminAddAnotherProductButton?.addEventListener('click', () => {
            adminAddProductFeedbackContainer.classList.add('hidden');
            resetProductForm();
        });
        adminViewStoreAfterAddButton?.addEventListener('click', () => {
            adminAddProductFeedbackContainer.classList.add('hidden');
            setActiveView('store-view');
        });


        if (addProductForm) {
            addProductForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const name = document.getElementById('product-name').value;
                const price = parseFloat(document.getElementById('product-price').value);
                const stock = parseInt(productStockInput.value, 10);
                let mainImageUrl = productImageMainUrlInput.value.trim();
                const additionalUrlsString = productAdditionalImageUrlsInput.value.trim();
                const description = document.getElementById('product-description').value;
                const categoryId = productCategorySelect.value;
                const editingId = editingProductIdInput.value;

                let imageUrls = [];
                if (uploadedImageFile && imagePreview.src) { 
                    imageUrls.push(imagePreview.src); 
                } else if (mainImageUrl) {
                    imageUrls.push(mainImageUrl);
                }

                if (additionalUrlsString) {
                    const urls = additionalUrlsString.split(',').map(url => url.trim()).filter(url => url);
                    imageUrls.push(...urls);
                }
                
                if (imageUrls.length === 0) { 
                    imageUrls.push('https://placehold.co/300x200/cccccc/969696?text=Sem+Imagem');
                }


                if (name && price > 0 && categoryId && stock >= 0) {
                    if (isEditingProduct && editingId) {
                        const productIndex = products.findIndex(p => p.id === editingId);
                        if (productIndex > -1) {
                            products[productIndex] = { 
                                ...products[productIndex], 
                                name, price, categoryId, imageUrls, description, stock,
                                reviews: products[productIndex].reviews || [] // Mantém as reviews existentes
                            };
                            adminAddProductFeedbackMessage.textContent = "Produto atualizado com sucesso!";
                        }
                    } else {
                        const newProduct = {
                            id: 'prod' + (products.length + 1) + Date.now(), 
                            name, price, categoryId, imageUrls, description, stock, reviews: []
                        };
                        products.push(newProduct);
                        adminAddProductFeedbackMessage.textContent = "Produto adicionado com sucesso!";
                    }
                    
                    adminAddProductFeedbackContainer.classList.remove('hidden');
                    renderAdminProducts(); 
                    renderStoreProducts(); 
                    renderCategoryFilters();
                    resetProductForm(); 
                } else {
                    const tempFeedback = addProductForm.querySelector('.product-add-feedback');
                    if(tempFeedback) tempFeedback.remove();

                    const feedback = document.createElement('p');
                    feedback.textContent = "Por favor, preencha nome, preço, estoque (mínimo 0) e selecione uma categoria.";
                    feedback.className = "text-red-500 text-sm mt-2 product-add-feedback";
                    addProductForm.querySelector('button[type="submit"]').insertAdjacentElement('afterend', feedback);
                    setTimeout(() => feedback.remove(), 3000);
                }
            });
        }
        
        function populateEditForm(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            isEditingProduct = true;
            editingProductIdInput.value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            productStockInput.value = product.stock;
            document.getElementById('product-description').value = product.description;
            document.getElementById('product-category-select').value = product.categoryId;
            
            productImageMainUrlInput.value = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : '';
            if (product.imageUrls && product.imageUrls.length > 0 && product.imageUrls[0]) {
                imagePreview.src = product.imageUrls[0];
                imagePreview.classList.remove('hidden');
            } else {
                imagePreview.classList.add('hidden');
                imagePreview.src = '';
            }
            uploadedImageFile = null; 

            const additionalUrls = (product.imageUrls && product.imageUrls.length > 1) ? product.imageUrls.slice(1).join(', ') : '';
            productAdditionalImageUrlsInput.value = additionalUrls;

            formProductTitle.textContent = "Editar Produto";
            submitProductFormButton.textContent = "Salvar Alterações";
            submitProductFormButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            submitProductFormButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            cancelEditProductButton.classList.remove('hidden');
            adminAddProductFeedbackContainer.classList.add('hidden'); 
            addProductForm.scrollIntoView({ behavior: 'smooth' });
        }

        addNewCategoryButton?.addEventListener('click', () => {
            const newCategoryName = newProductCategoryInput.value.trim();
            if (newCategoryName && !categories.find(c => c.name.toLowerCase() === newCategoryName.toLowerCase())) {
                const newCategoryId = 'cat' + Date.now();
                categories.push({ id: newCategoryId, name: newCategoryName });
                populateCategoryDropdown();
                renderCategoryFilters(); 
                productCategorySelect.value = newCategoryId; 
                newProductCategoryInput.value = '';
            } else if (newCategoryName) {
                showModal("Erro", "Essa categoria já existe.");
            } else {
                 showModal("Erro", "Por favor, insira um nome para a nova categoria.");
            }
        });

        function addEventListenersToRemoveProductButtons() {
            adminProductListContainer.querySelectorAll('.remove-product-button').forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                newButton.addEventListener('click', function() {
                    const productId = this.dataset.id;
                    showModal("Confirmar Remoção", "Tem certeza que deseja remover este produto?", () => {
                        products = products.filter(p => p.id !== productId);
                        renderAdminProducts(); 
                        renderStoreProducts(); 
                        if (editingProductIdInput.value === productId) { 
                            resetProductForm();
                        }
                    });
                });
            });

            adminProductListContainer.querySelectorAll('.edit-product-button').forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                newButton.addEventListener('click', function() {
                    const productId = this.dataset.id;
                    populateEditForm(productId);
                });
            });
        }
        
        if (imageDropZone) {
            imageDropZone.addEventListener('click', () => productImageFileInput.click());
            imageDropZone.addEventListener('dragover', (event) => { event.preventDefault(); imageDropZone.classList.add('dragover'); });
            imageDropZone.addEventListener('dragleave', () => imageDropZone.classList.remove('dragover'));
            imageDropZone.addEventListener('drop', (event) => {
                event.preventDefault(); imageDropZone.classList.remove('dragover');
                const files = event.dataTransfer.files;
                if (files.length > 0) handleImageFile(files[0]);
            });
            productImageFileInput.addEventListener('change', (event) => {
                const files = event.target.files;
                if (files.length > 0) handleImageFile(files[0]);
            });
        }

        function handleImageFile(file) {
            const feedbackDiv = addProductForm.querySelector('.image-upload-feedback');
            if (feedbackDiv) feedbackDiv.remove(); 
            if (file && file.type.startsWith('image/')) {
                uploadedImageFile = file; 
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    productImageMainUrlInput.value = ''; 
                }
                reader.readAsDataURL(file);
            } else {
                const feedback = document.createElement('p');
                feedback.textContent = "Por favor, selecione um arquivo de imagem válido.";
                feedback.className = "text-red-500 text-sm mt-1 image-upload-feedback"; 
                imageDropZone.parentNode.insertBefore(feedback, imageDropZone.nextSibling);
                uploadedImageFile = null; imagePreview.classList.add('hidden'); imagePreview.src = '';
            }
        }
        
        const cartItemsContainer = document.getElementById('cart-items-list'); 
        const cartTotalValueElement = document.getElementById('cart-total-value'); 
        const checkoutButtonSidebar = document.getElementById('checkout-button-sidebar'); 
        const cartEmptyMessage = document.getElementById('cart-empty-message'); 
        const cartTotalSection = document.getElementById('cart-total-section'); 

        checkoutButtonSidebar?.addEventListener('click', showCheckoutView); 

        function handleAddToCart(productData, buttonElement) {
            if (isAdminLoggedIn) {
                showModal("Aviso", "Funcionalidade de adicionar ao carrinho desabilitada no modo administrador.");
                return;
            }

            const productInStore = products.find(p => p.id === productData.id);
            if (!productInStore || productInStore.stock <= 0) {
                if (buttonElement) {
                    buttonElement.textContent = "Fora de Estoque";
                    buttonElement.disabled = true;
                }
                showModal("Produto Indisponível", `${productData.name} está fora de estoque.`);
                return;
            }

            const existingItem = cart.find(item => item.id === productData.id);
            if (existingItem) {
                if (productInStore.stock > existingItem.quantity) {
                    existingItem.quantity++;
                } else {
                    showModal("Estoque Insuficiente", `Não há mais estoque disponível para adicionar outra unidade de ${productData.name}.`);
                    return;
                }
            } else {
                cart.push({ ...productInStore, quantity: 1 });
            }
            updateCartDisplay(); 
            updateCartViewDedicatedDisplay(); 

            if (buttonElement) {
                const originalButtonText = "Adicionar ao Carrinho";
                buttonElement.textContent = "Adicionado!";
                buttonElement.disabled = true; 
                
                const feedbackDiv = buttonElement.nextElementSibling; 
                if (feedbackDiv && feedbackDiv.classList.contains('add-to-cart-feedback')) {
                    feedbackDiv.innerHTML = `
                        <p class="text-green-600 font-semibold mb-1">Produto adicionado!</p>
                        <a href="#" class="text-blue-600 hover:underline view-cart-link-feedback text-xs">Ver Carrinho</a> | 
                        <a href="#" class="text-gray-600 hover:underline continue-shopping-link-feedback text-xs">Continuar Comprando</a>
                    `;
                    feedbackDiv.classList.remove('hidden');
                    if(activeFeedbackTimeout) clearTimeout(activeFeedbackTimeout); 
                    const revertButtonAndHide = () => {
                        const currentProductStatus = products.find(p => p.id === productData.id);
                        if (currentProductStatus && currentProductStatus.stock > 0) {
                           buttonElement.textContent = originalButtonText; 
                           buttonElement.disabled = false;
                        } else {
                           buttonElement.textContent = "Fora de Estoque";
                           buttonElement.disabled = true;
                        }
                        feedbackDiv.classList.add('hidden');
                        feedbackDiv.innerHTML = '';
                    };
                    activeFeedbackTimeout = setTimeout(revertButtonAndHide, 4000);
                    feedbackDiv.querySelector('.view-cart-link-feedback')?.addEventListener('click', (e) => {
                        e.preventDefault(); e.stopPropagation();
                        clearTimeout(activeFeedbackTimeout);
                        revertButtonAndHide();
                        setActiveView('cart-view-dedicated'); 
                    });
                    feedbackDiv.querySelector('.continue-shopping-link-feedback')?.addEventListener('click', (e) => {
                        e.preventDefault(); e.stopPropagation();
                        clearTimeout(activeFeedbackTimeout);
                        revertButtonAndHide();
                    });
                } else { 
                     setTimeout(() => {
                        const currentProductStatus = products.find(p => p.id === productData.id);
                        if (currentProductStatus && currentProductStatus.stock > 0) {
                           buttonElement.textContent = originalButtonText;
                           buttonElement.disabled = false;
                        } else {
                           buttonElement.textContent = "Fora de Estoque";
                           buttonElement.disabled = true;
                        }
                    }, 1500);
                }
            }
        }

        function updateCartDisplay() { 
            if (!cartItemsContainer || !cartTotalValueElement || !checkoutButtonSidebar || !cartEmptyMessage || !cartTotalSection) return;
            cartItemsContainer.innerHTML = '';
            let total = 0;
            if (cart.length === 0) {
                cartEmptyMessage.classList.remove('hidden');
                cartTotalSection.classList.add('hidden');
            } else {
                cartEmptyMessage.classList.add('hidden');
                cartTotalSection.classList.remove('hidden');
                cart.forEach((item) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex justify-between items-center mb-4 pb-2 border-b border-gray-200';
                    itemElement.innerHTML = `
                        <div>
                            <h4 class="font-medium text-gray-600 truncate w-32" title="${item.name}">${item.name}</h4>
                            <p class="text-xs text-gray-500">${item.quantity} x R$ ${item.price.toFixed(2)}</p>
                        </div>
                        <button class="text-red-500 hover:text-red-700 text-sm remove-from-cart-button" data-id="${item.id}">Remover</button>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                    total += item.price * item.quantity;
                });
            }
            cartTotalValueElement.textContent = `R$ ${total.toFixed(2)}`;
            addEventListenersToRemoveFromCartButtons();
        }
        
        function updateCartViewDedicatedDisplay() { 
            if (!cartItemsListDedicated || !cartTotalValueDedicated || !cartEmptyMessageDedicated || !cartSummaryDedicated) return;
            cartItemsListDedicated.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                cartEmptyMessageDedicated.classList.remove('hidden');
                cartSummaryDedicated.classList.add('hidden');
            } else {
                cartEmptyMessageDedicated.classList.add('hidden');
                cartSummaryDedicated.classList.remove('hidden');
                cart.forEach((item) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex justify-between items-center p-4 border-b border-gray-200';
                    const mainImageUrl = item.imageUrls && item.imageUrls.length > 0 ? item.imageUrls[0] : 'https://placehold.co/60x60/cccccc/969696?text=N/A';
                    itemElement.innerHTML = `
                        <div class="flex items-center">
                            <img src="${mainImageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md mr-4">
                            <div>
                                <h4 class="font-semibold text-gray-700">${item.name}</h4>
                                <p class="text-sm text-gray-500">Quantidade: ${item.quantity}</p>
                                <p class="text-sm text-blue-600">Preço: R$ ${item.price.toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-gray-700">R$ ${(item.price * item.quantity).toFixed(2)}</p>
                            <button class="text-red-500 hover:text-red-700 text-xs mt-1 remove-from-cart-button-dedicated" data-id="${item.id}">Remover</button>
                        </div>
                    `;
                    cartItemsListDedicated.appendChild(itemElement);
                    total += item.price * item.quantity;
                });
            }
            cartTotalValueDedicated.textContent = `R$ ${total.toFixed(2)}`;
            addEventListenersToRemoveFromCartButtonsDedicated();
        }

        function addEventListenersToAddToCartButtons() {
            const addToCartListButtons = document.querySelectorAll('.add-to-cart-button-list');
            addToCartListButtons.forEach(button => {
                const newButton = button.cloneNode(true); 
                button.parentNode.replaceChild(newButton, button);
                newButton.addEventListener('click', (event) => {
                    event.stopPropagation(); 
                    const productCard = event.target.closest('.product-card');
                    const productId = productCard.dataset.id;
                    const product = products.find(p => p.id === productId);
                    if (product) handleAddToCart(product, newButton); 
                });
            });
        }
        
        function addEventListenersToRemoveFromCartButtons() { 
            const removeButtons = cartItemsContainer.querySelectorAll('.remove-from-cart-button');
            removeButtons.forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                newButton.addEventListener('click', (event) => {
                    const productIdToRemove = event.target.dataset.id;
                    cart = cart.filter(item => item.id !== productIdToRemove);
                    updateCartDisplay();
                    updateCartViewDedicatedDisplay(); 
                });
            });
        }

        function addEventListenersToRemoveFromCartButtonsDedicated() { 
            const removeButtons = cartItemsListDedicated.querySelectorAll('.remove-from-cart-button-dedicated');
            removeButtons.forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                newButton.addEventListener('click', (event) => {
                    const productIdToRemove = event.target.dataset.id;
                    cart = cart.filter(item => item.id !== productIdToRemove);
                    updateCartDisplay(); 
                    updateCartViewDedicatedDisplay();
                });
            });
        }
        
        function renderAdminProducts() { 
            if (!adminProductListContainer || !noAdminProductsMessage) return;
            adminProductListContainer.innerHTML = ''; 

            if (products.length === 0) {
                noAdminProductsMessage.classList.remove('hidden');
            } else {
                noAdminProductsMessage.classList.add('hidden');
                products.forEach(product => {
                    const categoryName = categories.find(c => c.id === product.categoryId)?.name || 'Sem Categoria';
                    const productDiv = document.createElement('div');
                    productDiv.className = 'flex justify-between items-center p-3 border border-gray-200 rounded-md bg-white shadow-sm';
                    const mainImageUrl = product.imageUrls && product.imageUrls.length > 0 ? product.imageUrls[0] : 'https://placehold.co/60x40/cccccc/969696?text=N/A';
                    productDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="${mainImageUrl}" alt="${product.name}" class="w-16 h-10 object-cover rounded-sm">
                            <div>
                                <h5 class="font-medium text-gray-700">${product.name}</h5>
                                <p class="text-xs text-gray-500">Categoria: ${categoryName}</p>
                                <p class="text-sm text-blue-500">R$ ${product.price.toFixed(2)}</p>
                                <p class="text-xs text-gray-500">Estoque: ${product.stock}</p>
                                <p class="text-xs text-gray-500 truncate w-64" title="${product.description}">${product.description || 'Sem descrição'}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button data-id="${product.id}" class="edit-product-button text-blue-500 hover:text-blue-700 font-medium py-1 px-3 rounded-md hover:bg-blue-100 transition-colors text-xs">Editar</button>
                            <button data-id="${product.id}" class="remove-product-button text-red-500 hover:text-red-700 font-medium py-1 px-3 rounded-md hover:bg-red-100 transition-colors text-xs">Remover</button>
                        </div>
                    `;
                    adminProductListContainer.appendChild(productDiv);
                });
            }
            addEventListenersToRemoveProductButtons(); 
        }

        copyPixKeyButton?.addEventListener('click', () => {
            pixKeyTextElement.select();
            try {
                document.execCommand('copy'); 
                copyFeedbackElement.textContent = "Chave Pix copiada!";
                copyFeedbackElement.classList.remove('hidden', 'text-red-600');
                copyFeedbackElement.classList.add('text-green-600');
                setTimeout(() => {
                    copyFeedbackElement.classList.add('hidden');
                }, 2000);
            } catch (err) {
                console.error   ('Falha ao copiar a chave Pix: ', err);
                copyFeedbackElement.textContent = "Erro ao copiar.";
                copyFeedbackElement.classList.remove('hidden', 'text-green-600');
                copyFeedbackElement.classList.add('text-red-600');
                setTimeout(() => {
                    copyFeedbackElement.classList.add('hidden');
                }, 2000);
            }
            window.getSelection().removeAllRanges(); 
        });

        paymentConfirmedButton?.addEventListener('click', () => {
            if (!loggedInClient) {
                showModal("Login Necessário", "Por favor, faça login como cliente para finalizar a compra.", null, false);
                return;
            }

            const deliveryOption = document.querySelector('input[name="deliveryOption"]:checked').value;
            let shippingAddress = null;
            let clientName = loggedInClient.name;
            let clientPhone = loggedInClient.phone;

            if (deliveryOption === 'delivery') {
                clientName = document.getElementById('delivery-name').value.trim();
                clientPhone = document.getElementById('delivery-phone').value.trim();
                const street = document.getElementById('delivery-street').value.trim();
                const number = document.getElementById('delivery-number').value.trim();
                const neighborhood = document.getElementById('delivery-neighborhood').value.trim();
                const city = document.getElementById('delivery-city').value.trim();
                const cep = document.getElementById('delivery-cep').value.trim();
                const reference = document.getElementById('delivery-reference').value.trim();

                if (!clientName || !clientPhone || !street || !number || !neighborhood || !city || !cep) {
                    showModal("Dados Incompletos", "Por favor, preencha todos os campos obrigatórios do endereço de entrega.", null, false);
                    return;
                }
                shippingAddress = { name: clientName, phone: clientPhone, street, number, neighborhood, city, cep, reference };
            }


            const saleDate = new Date();
            const newSale = {
                orderId: `order-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                clientId: loggedInClient.id,
                clientName: clientName, // Pode ser do cadastro ou do form de delivery
                clientPhone: clientPhone, // Pode ser do cadastro ou do form de delivery
                date: saleDate,
                items: cart.map(item => ({
                    productId: item.id,
                    name: item.name,
                    quantity: item.quantity,
                    priceAtSale: item.price, 
                    totalValue: item.price * item.quantity
                })),
                totalAmount: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                deliveryMethod: deliveryOption,
                shippingAddress: shippingAddress, // Nulo se for pickup
                status: deliveryOption === 'pickup' ? 'awaiting_pickup' : 'payment_confirmed', // Status inicial
                allowReview: false, // Só permite review após conclusão
                clientConfirmedDelivery: false // Nova flag
            };
            salesRecords.push(newSale);
            loggedInClient.orders.push(newSale.orderId); // Adiciona ID do pedido ao cliente

            cart.forEach(cartItem => {
                const productInStore = products.find(p => p.id === cartItem.id);
                if (productInStore) {
                    if (productInStore.stock >= cartItem.quantity) {
                        productInStore.stock -= cartItem.quantity;
                    } else {
                        productInStore.stock = 0; 
                    }
                }
            });

            showModal("Pagamento Confirmado!", 
                      "Obrigado por sua compra! Seu pedido foi registrado.", 
                      () => {
                            cart = []; 
                            updateCartDisplay();
                            updateCartViewDedicatedDisplay();
                            renderStoreProducts(); 
                            renderAdminProducts(); 
                            if(adminPanel.classList.contains('hidden') === false) { 
                                renderCashRegisterDisplay(currentSalesFilterPeriod); 
                            }
                            setActiveView('store-view'); 
                      }, 
                      false); 
        });

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
            return new Date(d.setDate(diff));
        }

        function filterSalesByPeriod(period) {
            const now = new Date();
            let startDate, endDate = new Date(now); 

            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                    break;
                case 'week':
                    startDate = getStartOfWeek(now);
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'all-time':
                default:
                    return salesRecords; 
            }
            
            return salesRecords.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate >= startDate && saleDate <= endDate;
            });
        }

        function renderCashRegisterDisplay(period) {
            currentSalesFilterPeriod = period;
            const filteredSales = filterSalesByPeriod(period);

            let totalSalesValue = 0;
            let totalProductsSold = 0;
            const productBreakdown = {};

            filteredSales.forEach(sale => {
                totalSalesValue += sale.totalAmount;
                sale.items.forEach(item => {
                    totalProductsSold += item.quantity;
                    if (!productBreakdown[item.productId]) {
                        productBreakdown[item.productId] = {
                            name: item.name,
                            quantity: 0,
                            totalValue: 0
                        };
                    }
                    productBreakdown[item.productId].quantity += item.quantity;
                    productBreakdown[item.productId].totalValue += item.totalValue;
                });
            });

            salesSummaryTotalEl.textContent = `R$ ${totalSalesValue.toFixed(2)}`;
            salesSummaryQuantityEl.textContent = totalProductsSold;

            salesProductBreakdownEl.innerHTML = '';
            if (Object.keys(productBreakdown).length === 0) {
                salesProductBreakdownEl.innerHTML = '<p class="text-gray-500">Nenhuma venda no período selecionado.</p>';
            } else {
                for (const productId in productBreakdown) {
                    const item = productBreakdown[productId];
                    const breakdownItemDiv = document.createElement('div');
                    breakdownItemDiv.className = 'p-3 border rounded-md bg-gray-50 flex justify-between items-center';
                    breakdownItemDiv.innerHTML = `
                        <div>
                            <h5 class="font-medium text-gray-700">${item.name}</h5>
                            <p class="text-sm text-gray-500">Quantidade Vendida: ${item.quantity}</p>
                        </div>
                        <p class="text-lg font-semibold text-green-600">R$ ${item.totalValue.toFixed(2)}</p>
                    `;
                    salesProductBreakdownEl.appendChild(breakdownItemDiv);
                }
            }
            
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-500', 'text-white'));
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.add('bg-gray-200', 'text-gray-700'));
            
            const activeBtn = document.getElementById(`filter-${period.replace('-', '')}`); 
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-blue-500', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
            }
        }

        filterTodayButton?.addEventListener('click', () => renderCashRegisterDisplay('today'));
        filterWeekButton?.addEventListener('click', () => renderCashRegisterDisplay('week'));
        filterMonthButton?.addEventListener('click', () => renderCashRegisterDisplay('month'));
        filterAllTimeButton?.addEventListener('click', () => renderCashRegisterDisplay('all-time'));

        // --- LISTA DE DESEJOS ---
        function toggleWishlistItem(productId, buttonElement) {
            if (!loggedInClient) {
                showModal("Login Necessário", "Faça login para adicionar produtos à sua lista de desejos.", null, false);
                return;
            }
            const productIndexInWishlist = loggedInClient.wishlist.indexOf(productId);
            if (productIndexInWishlist > -1) {
                loggedInClient.wishlist.splice(productIndexInWishlist, 1); // Remove
                if (buttonElement) buttonElement.classList.remove('active');
            } else {
                loggedInClient.wishlist.push(productId); // Adiciona
                if (buttonElement) buttonElement.classList.add('active');
            }
            // Se estiver na view da wishlist, re-renderiza
            if (wishlistView.classList.contains('hidden') === false) {
                showWishlistView();
            }
            // Atualiza o botão na página de detalhes do produto, se visível
            const detailWishlistButton = productDetailView.querySelector(`.wishlist-button[data-product-id="${productId}"]`);
            if (detailWishlistButton) {
                if (loggedInClient.wishlist.includes(productId)) {
                    detailWishlistButton.classList.add('active');
                } else {
                    detailWishlistButton.classList.remove('active');
                }
            }
        }

        function createProductCard(product, isWishlistView = false) {
            const card = document.createElement('div');
            card.className = "product-card bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm flex flex-col items-center text-center";
            card.dataset.id = product.id;
            const isOutOfStock = product.stock <= 0;
            const mainImageUrl = product.imageUrls && product.imageUrls.length > 0 ? product.imageUrls[0] : 'https://placehold.co/300x200/cccccc/969696?text=Sem+Imagem';
            const isInWishlist = loggedInClient && loggedInClient.wishlist.includes(product.id);

            card.innerHTML = `
                ${!isWishlistView ? `
                <button class="wishlist-button ${isInWishlist ? 'active' : ''}" data-product-id="${product.id}" title="Adicionar à Lista de Desejos">
                    <svg viewBox="0 0 24 24" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                </button>` : ''}
                <div class="relative w-full h-48 mb-4 product-image-container cursor-pointer" data-product-id="${product.id}">
                    <img src="${mainImageUrl}" alt="${product.name}" class="w-full h-full object-cover rounded-md">
                    ${isOutOfStock ? '<div class="out-of-stock-overlay">Fora de Estoque</div>' : ''}
                </div>
                <h3 class="text-lg font-medium text-gray-700 mb-1">${product.name}</h3>
                <p class="text-xl font-bold text-blue-600 mb-3">R$ ${product.price.toFixed(2)}</p>
                ${isWishlistView ? `
                    <button class="mt-2 w-full bg-red-500 text-white py-2 px-3 rounded-md hover:bg-red-600 remove-from-wishlist-btn" data-product-id="${product.id}">Remover</button>
                    <button class="mt-2 w-full bg-green-500 text-white py-2 px-3 rounded-md hover:bg-green-600 add-to-cart-from-wishlist-btn" data-product-id="${product.id}" ${isOutOfStock ? 'disabled' : ''}>
                        ${isOutOfStock ? 'Fora de Estoque' : 'Add ao Carrinho'}
                    </button>
                ` : `
                    <button class="mt-auto w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 add-to-cart-button-list" ${isOutOfStock ? 'disabled' : ''}>
                        ${isOutOfStock ? 'Fora de Estoque' : 'Adicionar ao Carrinho'}
                    </button>
                    <div class="add-to-cart-feedback hidden mt-2 text-sm w-full"></div>
                `}
            `;
            
            card.querySelector('.product-image-container')?.addEventListener('click', (e) => {
                showProductDetailView(e.currentTarget.dataset.productId);
            });

            if (isWishlistView) {
                card.querySelector('.remove-from-wishlist-btn').addEventListener('click', (e) => {
                    toggleWishlistItem(e.target.dataset.productId, null); // null for buttonElement as it will be re-rendered
                });
                const addToCartBtn = card.querySelector('.add-to-cart-from-wishlist-btn');
                if (addToCartBtn) {
                    addToCartBtn.addEventListener('click', (e) => {
                        const prod = products.find(p => p.id === e.target.dataset.productId);
                        if (prod) handleAddToCart(prod, e.target);
                    });
                }
            } else {
                 card.querySelector('.wishlist-button')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleWishlistItem(e.currentTarget.dataset.productId, e.currentTarget);
                });
            }
            return card;
        }

        // --- MODAL GENÉRICO ---
        function showModal(title, message, onConfirm, showCancel = true) {
            const existingModalOverlay = document.getElementById('generic-modal-overlay');
            if (existingModalOverlay) existingModalOverlay.remove();

            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'generic-modal-overlay';
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center p-4'; 
            
            const modalContent = document.createElement('div');
            modalContent.id = 'generic-modal';
            modalContent.className = 'bg-white p-6 rounded-lg shadow-xl max-w-sm w-full';

            modalContent.innerHTML = `
                <h3 class="text-xl font-semibold mb-4 text-gray-800">${title}</h3>
                <p class="text-gray-600 mb-6">${message}</p>
                <div class="flex justify-end gap-3">
                    ${showCancel ? '<button id="modal-cancel-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md">Cancelar</button>' : ''}
                    <button id="modal-confirm-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">${showCancel ? 'Confirmar' : 'OK'}</button>
                </div>
            `;
            
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);

            const closeModal = () => modalOverlay.remove();

            document.getElementById('modal-confirm-button').addEventListener('click', () => {
                if (onConfirm) onConfirm();
                closeModal();
            });

            if (showCancel) {
                document.getElementById('modal-cancel-button').addEventListener('click', closeModal);
            }
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeModal();
                }
            });
        }

        // --- GERENCIAMENTO DE PEDIDOS (ADMIN) ---
        function renderAdminOrders() {
            if (!adminOrdersListContainer) return;
            adminOrdersListContainer.innerHTML = '';

            if (salesRecords.length === 0) {
                adminOrdersListContainer.innerHTML = '<p class="text-gray-500">Nenhum pedido para gerenciar.</p>';
                return;
            }

            // Ordenar por data, mais recentes primeiro
            const sortedSales = [...salesRecords].sort((a,b) => new Date(b.date) - new Date(a.date));

            sortedSales.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'p-4 border rounded-md bg-white shadow-sm';
                
                let itemsHtml = order.items.map(item => `<li>${item.name} (Qtd: ${item.quantity}) - R$ ${item.totalValue.toFixed(2)}</li>`).join('');
                let addressHtml = '';
                if (order.deliveryMethod === 'delivery' && order.shippingAddress) {
                    const addr = order.shippingAddress;
                    addressHtml = `
                        <p class="text-xs text-gray-600 mt-1"><b>Endereço:</b> ${addr.street}, ${addr.number} - ${addr.neighborhood}, ${addr.city} - CEP: ${addr.cep}</p>
                        ${addr.reference ? `<p class="text-xs text-gray-600"><b>Ref:</b> ${addr.reference}</p>` : ''}
                    `;
                }

                orderDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-semibold text-gray-800">Pedido ID: ${order.orderId.substring(order.orderId.length - 6)}</h4>
                            <p class="text-xs text-gray-500">Data: ${new Date(order.date).toLocaleString('pt-BR')}</p>
                            <p class="text-xs text-gray-500">Cliente: ${order.clientName || 'N/A'} (${order.clientPhone || 'N/A'})</p>
                            <p class="text-xs text-gray-500">Modalidade: ${order.deliveryMethod === 'pickup' ? 'Retirada na Loja' : 'Entrega (Delivery)'}</p>
                        </div>
                        <p class="font-bold text-lg text-blue-600">R$ ${order.totalAmount.toFixed(2)}</p>
                    </div>
                    <details class="text-xs">
                        <summary class="cursor-pointer text-blue-500 hover:underline">Ver Itens e Endereço</summary>
                        <ul class="list-disc pl-5 mt-1 text-gray-600">${itemsHtml}</ul>
                        ${addressHtml}
                    </details>
                    <div class="mt-3">
                        <label for="status-${order.orderId}" class="block text-sm font-medium text-gray-600 mb-1">Status do Pedido:</label>
                        <select id="status-${order.orderId}" data-order-id="${order.orderId}" class="admin-order-status-select w-full p-2 border border-gray-300 rounded-md text-sm">
                            ${order.deliveryMethod === 'delivery' ? `
                                <option value="payment_confirmed" ${order.status === 'payment_confirmed' ? 'selected' : ''}>Pagamento Confirmado</option>
                                <option value="in_preparation" ${order.status === 'in_preparation' ? 'selected' : ''}>Em Preparação</option>
                                <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Enviado</option>
                                <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Concluído (Entregue)</option>
                            ` : `
                                <option value="awaiting_pickup" ${order.status === 'awaiting_pickup' ? 'selected' : ''}>Aguardando Retirada</option>
                                <option value="pickup_completed" ${order.status === 'pickup_completed' ? 'selected' : ''}>Retirada Finalizada</option>
                            `}
                             <option value="canceled" ${order.status === 'canceled' ? 'selected' : ''}>Cancelado</option>
                        </select>
                    </div>
                `;
                adminOrdersListContainer.appendChild(orderDiv);
            });

            document.querySelectorAll('.admin-order-status-select').forEach(select => {
                select.addEventListener('change', function() {
                    const orderId = this.dataset.orderId;
                    const newStatus = this.value;
                    updateOrderStatus(orderId, newStatus);
                });
            });
        }

        function updateOrderStatus(orderId, newStatus) {
            const order = salesRecords.find(o => o.orderId === orderId);
            if (order) {
                order.status = newStatus;
                // Se o admin marcar como concluído, também confirma a entrega pelo cliente (para liberar review)
                if (newStatus === 'completed' && order.deliveryMethod === 'delivery') {
                    order.clientConfirmedDelivery = true;
                    order.allowReview = true;
                } else if (newStatus === 'pickup_completed') {
                     order.allowReview = true;
                } else if (newStatus !== 'shipped' && order.deliveryMethod === 'delivery') { 
                    // Se não for 'shipped' (e for delivery), e não for 'completed', reseta a confirmação do cliente
                    // Isso é para o caso do admin reverter um status 'completed'
                    order.clientConfirmedDelivery = false;
                    order.allowReview = false;
                } else if (order.deliveryMethod === 'delivery' && newStatus === 'shipped') {
                    // Se for 'shipped', não mexe no allowReview ainda, espera confirmação do cliente
                    order.clientConfirmedDelivery = false; // Garante que está falso
                    order.allowReview = false;
                } else {
                     order.allowReview = false;
                }

                if (clientOrdersView.classList.contains('hidden') === false && loggedInClient && loggedInClient.orders.includes(orderId)) {
                    renderClientOrders();
                }
                 showModal("Status Atualizado", `Status do pedido ${orderId.substring(orderId.length - 6)} alterado para ${newStatus}.`, null, false);
            }
        }
        
        // --- AVALIAÇÕES DE PRODUTO (CLIENTE) ---
        function renderClientOrders() {
            if (!clientOrdersListContainer || !loggedInClient) return;
            clientOrdersListContainer.innerHTML = '';
            const clientOrderIds = loggedInClient.orders;

            if (clientOrderIds.length === 0) {
                noClientOrdersMessage.classList.remove('hidden');
                return;
            }
            noClientOrdersMessage.classList.add('hidden');

            const clientSales = salesRecords.filter(sale => clientOrderIds.includes(sale.orderId))
                                         .sort((a,b) => new Date(b.date) - new Date(a.date));

            clientSales.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'p-4 border rounded-md bg-white shadow';
                let itemsHtml = order.items.map(item => `<li>${item.name} (Qtd: ${item.quantity})</li>`).join('');
                
                let statusText = order.status;
                // Mapeamento de status para texto amigável
                const statusMap = {
                    'payment_confirmed': 'Pagamento Confirmado',
                    'in_preparation': 'Em Preparação',
                    'shipped': 'Enviado',
                    'completed': 'Concluído (Entregue)',
                    'awaiting_pickup': 'Aguardando Retirada',
                    'pickup_completed': 'Retirada Finalizada',
                    'canceled': 'Cancelado'
                };
                statusText = statusMap[order.status] || order.status;

                let confirmDeliveryButtonHtml = '';
                if (order.deliveryMethod === 'delivery' && order.status === 'shipped' && !order.clientConfirmedDelivery) {
                    confirmDeliveryButtonHtml = `<button class="confirm-delivery-btn mt-2 bg-teal-500 hover:bg-teal-600 text-white text-xs py-1 px-2 rounded" data-order-id="${order.orderId}">Confirmar Entrega</button>`;
                }


                orderDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-semibold text-gray-800">Pedido ID: ${order.orderId.substring(order.orderId.length-6)}</h4>
                            <p class="text-xs text-gray-500">Data: ${new Date(order.date).toLocaleDateString('pt-BR')}</p>
                            <p class="text-sm text-gray-700">Status: <span class="font-medium">${statusText}</span></p>
                        </div>
                        <p class="font-bold text-lg text-blue-600">R$ ${order.totalAmount.toFixed(2)}</p>
                    </div>
                    <ul class="text-xs list-disc pl-5 mt-1 text-gray-600">${itemsHtml}</ul>
                    ${confirmDeliveryButtonHtml}
                    ${order.allowReview ? `<div id="review-section-${order.orderId}" class="mt-3 pt-3 border-t"></div>` : ''}
                `;
                clientOrdersListContainer.appendChild(orderDiv);

                if (order.allowReview) {
                    renderReviewFormForOrder(order, `review-section-${order.orderId}`);
                }
            });

            // Adiciona event listeners para os botões de confirmar entrega
            document.querySelectorAll('.confirm-delivery-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.dataset.orderId;
                    handleClientConfirmDelivery(orderId);
                });
            });
        }
        
        function handleClientConfirmDelivery(orderId) {
            const order = salesRecords.find(o => o.orderId === orderId);
            if (order && order.deliveryMethod === 'delivery' && order.status === 'shipped') {
                order.clientConfirmedDelivery = true;
                order.allowReview = true; // Libera avaliação após confirmação
                order.status = 'completed'; // Opcional: Mudar status para 'completed' aqui também
                renderClientOrders(); // Re-renderiza a lista de pedidos do cliente
                showModal("Entrega Confirmada", "Obrigado por confirmar o recebimento do seu pedido! Agora você pode avaliar os produtos.", null, false);
            }
        }


        function renderReviewFormForOrder(order, containerId) {
            const reviewSection = document.getElementById(containerId);
            if (!reviewSection) return;
            reviewSection.innerHTML = '<h5 class="text-sm font-semibold mb-2">Avalie os produtos deste pedido:</h5>';

            order.items.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (!product) return;

                const existingReview = product.reviews.find(r => r.clientId === loggedInClient.id && r.orderId === order.orderId);

                if (existingReview) {
                    reviewSection.innerHTML += `
                        <div class="mb-2 p-2 bg-gray-100 rounded">
                            <p class="text-xs font-medium">${item.name}: <span class="text-yellow-500">${'★'.repeat(existingReview.rating)}${'☆'.repeat(5 - existingReview.rating)}</span> (Sua avaliação)</p>
                            ${existingReview.comment ? `<p class="text-xs text-gray-600 italic">"${existingReview.comment}"</p>` : ''}
                        </div>`;
                } else {
                    const formId = `review-form-${order.orderId}-${item.productId}`;
                    reviewSection.innerHTML += `
                        <form id="${formId}" data-product-id="${item.productId}" data-order-id="${order.orderId}" class="mb-3 p-2 border rounded">
                            <p class="text-xs font-medium mb-1">${item.name}</p>
                            <div class="star-rating mb-1" data-rating="0">
                                <span data-value="1">★</span><span data-value="2">★</span><span data-value="3">★</span><span data-value="4">★</span><span data-value="5">★</span>
                            </div>
                            <textarea class="w-full p-1 border rounded text-xs" rows="2" placeholder="Seu comentário (opcional)"></textarea>
                            <button type="submit" class="mt-1 bg-blue-500 text-white text-xs py-1 px-2 rounded hover:bg-blue-600">Enviar Avaliação</button>
                        </form>
                    `;
                }
            });
            
            document.querySelectorAll(`#${containerId} .star-rating span`).forEach(star => {
                star.addEventListener('click', function() {
                    const ratingContainer = this.parentElement;
                    const rating = this.dataset.value;
                    ratingContainer.dataset.rating = rating; 
                    Array.from(ratingContainer.children).forEach((s, i) => {
                        s.classList.toggle('selected', i < rating);
                    });
                });
            });
            document.querySelectorAll(`#${containerId} form`).forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const productId = this.dataset.productId;
                    const orderId = this.dataset.orderId;
                    const rating = parseInt(this.querySelector('.star-rating').dataset.rating);
                    const comment = this.querySelector('textarea').value.trim();

                    if (rating === 0) {
                        showModal("Avaliação Incompleta", "Por favor, selecione pelo menos uma estrela.", null, false);
                        return;
                    }
                    submitProductReview(productId, orderId, rating, comment);
                    renderClientOrders(); 
                });
            });
        }

        function submitProductReview(productId, orderId, rating, comment) {
            const product = products.find(p => p.id === productId);
            if (product && loggedInClient) {
                product.reviews = product.reviews.filter(r => !(r.clientId === loggedInClient.id && r.orderId === orderId));
                
                product.reviews.push({
                    clientId: loggedInClient.id,
                    clientName: loggedInClient.name, 
                    orderId: orderId, 
                    rating: rating,
                    comment: comment,
                    date: new Date().toISOString()
                });
                showModal("Avaliação Enviada", "Obrigado pela sua avaliação!", null, false);
            }
        }


        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            updateClientMenu(); 
            showStoreView(); 
            updateCartDisplay(); 
        });
        
        document.getElementById('store-logo')?.addEventListener('click', (e) => {
            e.preventDefault();
            currentCategoryFilter = 'cat0'; 
            currentSearchTerm = ''; 
            if(searchProductInput) searchProductInput.value = '';
            setActiveView('store-view');
        });
        document.querySelector('#store-nav a[onclick="showStoreView()"]')?.addEventListener('click', (e) => { 
            if (e.target.textContent === "Início") {
                e.preventDefault();
                currentCategoryFilter = 'cat0'; 
                currentSearchTerm = ''; 
                if(searchProductInput) searchProductInput.value = '';
                setActiveView('store-view');
            }
        });
        searchProductInput?.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value;
            renderStoreProducts();
        });

    </script>

</body>
</html>
